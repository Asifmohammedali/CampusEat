<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart ‚Äî CampusEats</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --bg:#faf8f4; --bg2:#f3f0ea; --card:#fff; --border:#e8e3d9; --accent:#d4521a; --accent2:#f5a623; --text:#1a1815; --muted:#8a847a; --muted2:#c5bfb4; --dark:#1a1815; --success:#4caf7d; --error:#ff5c5c; }
    body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; }

    /* Header */
    header { position: sticky; top: 0; z-index: 100; background: rgba(250,248,244,0.9); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-mark { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent2), var(--accent)); border-radius: 10px; display: grid; place-items: center; font-size: 1.1rem; }
    .logo-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.15rem; color: var(--text); letter-spacing: -0.02em; }
    .logo-text span { color: var(--accent); }
    .header-nav { display: flex; align-items: center; gap: 0.25rem; }
    .nav-link { padding: 0.45rem 0.9rem; border-radius: 8px; text-decoration: none; color: var(--muted); font-size: 0.83rem; font-weight: 500; transition: background 0.15s, color 0.15s; }
    .nav-link:hover { background: var(--bg2); color: var(--text); }
    .nav-link.active { background: rgba(212,82,26,0.08); color: var(--accent); font-weight: 600; }
    .header-right { display: flex; align-items: center; gap: 0.7rem; }
    .user-chip { display: flex; align-items: center; gap: 8px; background: var(--bg2); border: 1px solid var(--border); border-radius: 30px; padding: 0.28rem 0.9rem 0.28rem 0.28rem; }
    .user-avatar { width: 28px; height: 28px; background: linear-gradient(135deg, var(--accent2), var(--accent)); border-radius: 50%; display: grid; place-items: center; font-size: 0.7rem; font-weight: 700; color: #fff; font-family: 'Syne', sans-serif; }
    .user-name { font-size: 0.82rem; font-weight: 600; }
    .btn-logout { padding: 0.42rem 0.9rem; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.82rem; cursor: pointer; text-decoration: none; transition: border-color 0.2s, color 0.2s; }
    .btn-logout:hover { border-color: var(--accent); color: var(--accent); }

    /* Content */
    .content { max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem; }
    .page-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.6rem; letter-spacing: -0.03em; margin-bottom: 1.8rem; }
    .page-title span { color: var(--accent); }

    /* Alert */
    .alert { border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.84rem; margin-bottom: 1.3rem; }
    .alert-error   { background: rgba(255,92,92,0.08); border: 1px solid rgba(255,92,92,0.25); color: var(--error); }
    .alert-success { background: rgba(76,175,125,0.08); border: 1px solid rgba(76,175,125,0.25); color: var(--success); }

    /* Grid */
    .cart-grid { display: grid; grid-template-columns: 1fr 300px; gap: 1.4rem; align-items: start; }
    @media (max-width: 720px) { .cart-grid { grid-template-columns: 1fr; } }

    /* Cart items */
    .cart-items-card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; }
    .cart-items-header { padding: 1.1rem 1.3rem; border-bottom: 1px solid var(--border); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.92rem; display: flex; align-items: center; justify-content: space-between; }
    .item-count { font-size: 0.72rem; background: rgba(212,82,26,0.08); color: var(--accent); border: 1px solid rgba(212,82,26,0.15); border-radius: 20px; padding: 2px 10px; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; }

    .cart-row { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.3rem; border-bottom: 1px solid var(--border); }
    .cart-row:last-child { border-bottom: none; }
    .cart-thumb { width: 52px; height: 52px; border-radius: 10px; background: var(--bg2); border: 1px solid var(--border); overflow: hidden; display: grid; place-items: center; font-size: 1.4rem; flex-shrink: 0; }
    .cart-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .cart-info { flex: 1; min-width: 0; }
    .cart-item-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.9rem; }
    .cart-item-cat  { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
    .cart-item-price { font-size: 0.78rem; color: var(--muted); margin-top: 3px; }

    /* Qty control */
    .qty-row { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .qty-ctrl { display: flex; align-items: center; background: var(--bg2); border: 1px solid var(--border); border-radius: 9px; overflow: hidden; }
    .qb { width: 28px; height: 28px; border: none; background: transparent; color: var(--text); font-size: 1rem; cursor: pointer; display: grid; place-items: center; font-family: 'Syne', sans-serif; font-weight: 700; transition: background 0.15s; }
    .qb:hover { background: var(--border); }
    .qn { width: 28px; text-align: center; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.85rem; }
    .subtotal { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.95rem; min-width: 60px; text-align: right; flex-shrink: 0; }
    .remove-btn { width: 26px; height: 26px; border-radius: 7px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.7rem; cursor: pointer; display: grid; place-items: center; transition: background 0.15s, color 0.15s; flex-shrink: 0; }
    .remove-btn:hover { background: rgba(255,92,92,0.08); color: var(--error); border-color: rgba(255,92,92,0.3); }
    .not-in-menu { background: rgba(255,92,92,0.04); border-color: rgba(255,92,92,0.25); }
    .not-in-menu-tag { font-size: 0.65rem; font-weight: 600; color: var(--error); background: rgba(255,92,92,0.08); border: 1px solid rgba(255,92,92,0.2); border-radius: 5px; padding: 1px 6px; margin-left: 6px; letter-spacing: 0.04em; }

    /* Summary card */
    .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 1.4rem; position: sticky; top: 80px; }
    .summary-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; margin-bottom: 1.1rem; }

    /* Wallet indicator */
    .wallet-row { display: flex; align-items: center; justify-content: space-between; background: {% if wallet_balance >= grand_total %}rgba(76,175,125,0.06){% else %}rgba(255,92,92,0.06){% endif %}; border: 1px solid {% if wallet_balance >= grand_total %}rgba(76,175,125,0.2){% else %}rgba(255,92,92,0.2){% endif %}; border-radius: 10px; padding: 0.65rem 0.9rem; margin-bottom: 1rem; }
    .wallet-label { font-size: 0.78rem; color: var(--muted); }
    .wallet-amount { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.95rem; color: {% if wallet_balance >= grand_total %}var(--success){% else %}var(--error){% endif %}; }

    .summary-row { display: flex; justify-content: space-between; font-size: 0.83rem; margin-bottom: 0.55rem; }
    .summary-row .label { color: var(--muted); }
    .summary-row .value { font-weight: 600; }
    .summary-divider { height: 1px; background: var(--border); margin: 0.8rem 0; }
    .summary-total { display: flex; justify-content: space-between; align-items: center; }
    .summary-total .t-label { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .summary-total .t-value { font-family: 'Syne', sans-serif; font-weight: 900; font-size: 1.3rem; }

    .btn-order { width: 100%; margin-top: 1.1rem; padding: 0.85rem; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--accent2), var(--accent)); color: #fff; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.95rem; cursor: pointer; transition: opacity 0.2s, transform 0.15s; }
    .btn-order:hover { opacity: 0.88; }
    .btn-order:active { transform: scale(0.98); }
    .btn-order:disabled { background: var(--muted2); cursor: not-allowed; opacity: 1; }

    .insufficient-note { font-size: 0.73rem; color: var(--error); text-align: center; margin-top: 0.6rem; }

    /* Empty */
    .empty-cart { text-align: center; padding: 4rem 2rem; color: var(--muted); }
    .empty-icon { font-size: 3rem; opacity: 0.2; margin-bottom: 0.8rem; }
    .empty-text { font-size: 0.88rem; margin-bottom: 1.2rem; }
    .btn-browse { display: inline-block; padding: 0.65rem 1.4rem; border-radius: 10px; background: var(--dark); color: #fff; text-decoration: none; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.85rem; transition: opacity 0.2s; }
    .btn-browse:hover { opacity: 0.85; }
  </style>
</head>
<body>

<header>
  <a href="{% url 'student_dashboard' %}" class="logo">
    <div class="logo-mark">üçΩ</div>
    <div class="logo-text">Campus<span>Eats</span></div>
  </a>
  <nav class="header-nav">
    <a href="{% url 'student_dashboard' %}"     class="nav-link">Menu</a>
    <a href="{% url 'student_order_status' %}"  class="nav-link active">Order Status</a>
    <a href="{% url 'order_history_student' %}" class="nav-link">Orders</a>
    <a href="{% url 'student_wallet' %}"        class="nav-link">Wallet</a>
  </nav>
  <div class="header-right">
    <div class="user-chip">
      <div class="user-avatar">{{ user.name|first|upper }}</div>
      <span class="user-name">{{ user.name }}</span>
    </div>
    <a href="{% url 'view_cart' %}" class="cart-btn">
      üõí
      {% if cart_count > 0 %}<span class="cart-count">{{ cart_count }}</span>{% endif %}
    </a>
    <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
  </div>
</header>

<div class="content">
  <div class="page-title">Your <span>Cart</span></div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-success{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if has_unavailable %}
    <div class="alert alert-error">
      ‚ö†Ô∏è Some items in your cart are not available in today's menu. They are highlighted below. Please remove them before placing your order.
    </div>
  {% endif %}

  {% if cart_items %}
  <div class="cart-grid">

    <!-- Items -->
    <div class="cart-items-card">
      <div class="cart-items-header">
        Cart Items
        <span class="item-count">{{ cart_count }} item{{ cart_count|pluralize }}</span>
      </div>

      {% for ci in cart_items %}
        <div class="cart-row {% if not ci.in_todays_menu %}not-in-menu{% endif %}" id="row-{{ ci.id }}">
          <div class="cart-thumb">
            {% if ci.item.image %}<img src="{{ ci.item.image.url }}" alt="{{ ci.item.name }}"/>{% else %}üçΩ{% endif %}
          </div>
          <div class="cart-info">
            <div class="cart-item-name">
              {{ ci.item.name }}
              {% if not ci.in_todays_menu %}<span class="not-in-menu-tag">Not in today's menu</span>{% endif %}
            </div>
            <div class="cart-item-cat">{{ ci.item.category.name }}</div>
            <div class="cart-item-price">‚Çπ{{ ci.price }} each</div>
          </div>
          <div class="qty-row">
            <div class="qty-ctrl">
              <button class="qb" onclick="updateQty({{ ci.id }}, 'decrement')">‚àí</button>
              <span class="qn" id="qn-{{ ci.id }}">{{ ci.quantity }}</span>
              <button class="qb" onclick="updateQty({{ ci.id }}, 'increment')">Ôºã</button>
            </div>
            <div class="subtotal" id="sub-{{ ci.id }}">‚Çπ{{ ci.subtotal }}</div>
            <a href="{% url 'remove_cart_item' ci.id %}" class="remove-btn" title="Remove">‚úï</a>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Summary -->
    <div class="summary-card">
      <div class="summary-title">Order Summary</div>

      <!-- Wallet balance indicator -->
      <div class="wallet-row">
        <span class="wallet-label">üí∞ Wallet Balance</span>
        <span class="wallet-amount">‚Çπ{{ wallet_balance|floatformat:2 }}</span>
      </div>

      {% for ci in cart_items %}
        <div class="summary-row">
          <span class="label">{{ ci.item.name }} √ó{{ ci.quantity }}</span>
          <span class="value">‚Çπ{{ ci.subtotal }}</span>
        </div>
      {% endfor %}

      <div class="summary-divider"></div>
      <div class="summary-total">
        <span class="t-label">Grand Total</span>
        <span class="t-value" id="grandTotal">‚Çπ{{ grand_total|floatformat:2 }}</span>
      </div>

      <form method="POST" action="{% url 'place_order' %}">
        {% csrf_token %}
        {% if has_unavailable %}
          <button type="button" class="btn-order" disabled>Remove Unavailable Items</button>
          <div class="insufficient-note">Remove items not in today's menu to proceed.</div>
        {% elif wallet_balance < grand_total %}
          <button type="button" class="btn-order" disabled>Insufficient Balance</button>
          <div class="insufficient-note">
            You need ‚Çπ{{ grand_total|floatformat:2 }} but have ‚Çπ{{ wallet_balance|floatformat:2 }}.
            Please recharge your wallet.
          </div>
        {% else %}
          <button type="submit" class="btn-order">Place Order ‚Üí</button>
        {% endif %}
      </form>
    </div>
  </div>

  {% else %}
    <div class="empty-cart">
      <div class="empty-icon">üõí</div>
      <div class="empty-text">Your cart is empty.</div>
      <a href="{% url 'student_dashboard' %}" class="btn-browse">Browse Today's Menu</a>
    </div>
  {% endif %}
</div>

<script>
  const CSRF = '{{ csrf_token }}';

  function updateQty(cartItemId, action) {
    fetch("{% url 'update_cart' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': CSRF },
      body: `cart_item_id=${cartItemId}&action=${action}`
    })
    .then(r => r.json())
    .then(data => {
      if (data.removed) {
        document.getElementById(`row-${cartItemId}`).remove();
        location.reload(); // reload to update totals
        return;
      }
      if (data.success) {
        document.getElementById(`qn-${cartItemId}`).textContent  = data.quantity;
        document.getElementById(`sub-${cartItemId}`).textContent = '‚Çπ' + parseFloat(data.subtotal).toFixed(2);
        location.reload(); // reload to recalculate grand total & wallet check
      }
    });
  }
</script>
</body>
</html>