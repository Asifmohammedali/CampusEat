<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History ‚Äî CampusEats Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:        #0b0b0a;
      --sidebar:   #111110;
      --card:      #181816;
      --border:    #272522;
      --accent:    #f5a623;
      --accent2:   #e8431a;
      --text:      #ede9e0;
      --muted:     #6b6860;
      --muted2:    #3a3835;
      --input-bg:  #0f0f0e;
      --hover:     #1e1d1b;
      --success:   #4caf7d;
      --error:     #ff5c5c;
      --sidebar-w: 260px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; }
    .layout { display: flex; height: 100vh; overflow: hidden; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar { width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
    .sidebar-brand { display: flex; align-items: center; gap: 10px; padding: 1.4rem 1.2rem 1.2rem; border-bottom: 1px solid var(--border); }
    .brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 9px; display: grid; place-items: center; font-size: 1rem; }
    .brand-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.05rem; letter-spacing: -0.02em; }
    .brand-text span { color: var(--accent); }
    .admin-pill { margin: 1rem 1rem 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem 0.9rem; display: flex; align-items: center; gap: 10px; }
    .admin-avatar { width: 34px; height: 34px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 50%; display: grid; place-items: center; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; color: #0b0b0a; flex-shrink: 0; }
    .admin-name { font-weight: 600; font-size: 0.82rem; }
    .admin-role { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.08em; }
    .nav-section { padding: 1rem 0.8rem 0.2rem; }
    .nav-label { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted2); padding: 0 0.4rem; margin-bottom: 0.35rem; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 0.55rem 0.75rem; border-radius: 9px; color: var(--muted); text-decoration: none; font-size: 0.855rem; transition: background 0.15s, color 0.15s; margin-bottom: 2px; }
    .nav-item:hover { background: var(--hover); color: var(--text); }
    .nav-item.active { background: rgba(245,166,35,0.1); color: var(--accent); }
    .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; opacity: 0.6; }
    .nav-item:hover .nav-icon, .nav-item.active .nav-icon { opacity: 1; }
    .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--border); }
    .logout-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 0.55rem 0.75rem; border-radius: 9px; background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 0.855rem; cursor: pointer; transition: background 0.15s, color 0.15s; text-decoration: none; }
    .logout-btn:hover { background: rgba(232,67,26,0.08); color: var(--accent2); border-color: rgba(232,67,26,0.3); }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar { height: 58px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.8rem; flex-shrink: 0; }
    .topbar-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
    .topbar-breadcrumb { font-size: 0.72rem; color: var(--muted); }
    .topbar-badge { background: rgba(245,166,35,0.12); color: var(--accent); border: 1px solid rgba(245,166,35,0.25); border-radius: 6px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; padding: 3px 8px; }
    .content { flex: 1; overflow-y: auto; padding: 1.8rem; animation: fadeIn 0.35s ease both; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .section-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.35rem; letter-spacing: -0.03em; margin-bottom: 1.4rem; }
    .section-title span { color: var(--accent); }

    /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
    .toolbar { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1rem 1.2rem; margin-bottom: 1.3rem; display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap; }

    .search-wrap { position: relative; flex: 1; min-width: 180px; }
    .search-wrap input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); border-radius: 9px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; padding: 0.6rem 0.9rem 0.6rem 2.1rem; outline: none; transition: border-color 0.2s; }
    .search-wrap input:focus { border-color: var(--accent); }
    .search-wrap input::placeholder { color: var(--muted2); }
    .search-wrap::before { content: '‚åï'; position: absolute; left: 0.7rem; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 1rem; pointer-events: none; }

    .toolbar-divider { width: 1px; height: 26px; background: var(--border); flex-shrink: 0; }

    .filter-pills { display: flex; gap: 5px; flex-wrap: wrap; }
    .fpill { padding: 0.38rem 0.85rem; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 0.77rem; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.15s; white-space: nowrap; }
    .fpill:hover { border-color: var(--accent); color: var(--accent); }
    .fpill.active { background: var(--accent); border-color: var(--accent); color: #0b0b0a; font-weight: 700; }

    .custom-range { display: flex; align-items: center; gap: 5px; }
    .date-input { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; padding: 0.38rem 0.65rem; outline: none; transition: border-color 0.2s; }
    .date-input:focus { border-color: var(--accent); }
    .date-sep { font-size: 0.72rem; color: var(--muted); }
    .btn-apply { padding: 0.38rem 0.85rem; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #0b0b0a; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.77rem; cursor: pointer; white-space: nowrap; }

    .btn-search { padding: 0.6rem 1.1rem; border-radius: 9px; border: none; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #0b0b0a; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.82rem; cursor: pointer; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Results meta ‚îÄ‚îÄ */
    .results-meta { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.9rem; }
    .results-meta strong { color: var(--text); }

    /* ‚îÄ‚îÄ Orders table ‚îÄ‚îÄ */
    .table-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { font-size: 0.68rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; padding: 0.7rem 1rem; text-align: left; border-bottom: 1px solid var(--border); background: var(--input-bg); white-space: nowrap; }
    tbody td { padding: 0.85rem 1rem; border-bottom: 1px solid #1c1b19; font-size: 0.875rem; vertical-align: middle; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: #0f0f0e; }

    .order-id-cell { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.88rem; }
    .student-cell .s-name { font-weight: 500; }
    .student-cell .s-adm  { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
    .date-cell { font-size: 0.82rem; color: var(--muted); white-space: nowrap; }
    .amount-cell { font-family: 'Syne', sans-serif; font-weight: 800; color: var(--accent); }

    /* Status pills */
    .status-pill { font-size: 0.67rem; font-weight: 700; border-radius: 20px; padding: 3px 10px; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .PENDING   { background: rgba(245,166,35,0.1);  color: #f5a623; border: 1px solid rgba(245,166,35,0.25); }
    .CONFIRMED { background: rgba(76,175,125,0.1);  color: var(--success); border: 1px solid rgba(76,175,125,0.25); }
    .PREPARING { background: rgba(212,82,26,0.1);   color: #d4521a; border: 1px solid rgba(212,82,26,0.25); }
    .READY     { background: rgba(76,175,125,0.15); color: var(--success); border: 1px solid rgba(76,175,125,0.35); }
    .COMPLETED { background: rgba(237,233,224,0.06); color: var(--muted); border: 1px solid var(--border); }
    .CANCELLED { background: rgba(255,92,92,0.08);  color: var(--error);   border: 1px solid rgba(255,92,92,0.2); }
    .REJECTED  { background:rgba(255,92,92,0.1);   color:#ff5c5c; border:1px solid rgba(255,92,92,0.3); }
    /* Show detail button */
    .btn-detail { padding: 0.38rem 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
    .btn-detail:hover { border-color: rgba(245,166,35,0.4); color: var(--accent); background: rgba(245,166,35,0.06); }

    /* Empty */
    .empty-state { text-align: center; padding: 3.5rem 1rem; color: var(--muted); }
    .empty-icon  { font-size: 2rem; opacity: 0.2; margin-bottom: 0.6rem; }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--card); border: 1px solid var(--border); border-radius: 18px; width: 100%; max-width: 640px; max-height: 85vh; display: flex; flex-direction: column; animation: mIn 0.25s cubic-bezier(.34,1.56,.64,1); }
    @keyframes mIn { from { opacity:0; transform:scale(0.93) translateY(16px); } to { opacity:1; transform:scale(1) translateY(0); } }

    .modal-topbar { display: flex; align-items: center; justify-content: space-between; padding: 1.1rem 1.4rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .modal-heading { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .modal-close { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 0.8rem; cursor: pointer; display: grid; place-items: center; transition: background 0.15s, color 0.15s; }
    .modal-close:hover { background: rgba(232,67,26,0.1); color: var(--accent2); border-color: rgba(232,67,26,0.3); }

    .modal-body { padding: 1.3rem 1.4rem; overflow-y: auto; flex: 1; }
    .modal-loading { text-align: center; padding: 2rem; color: var(--muted); font-size: 0.85rem; }

    /* Partial styles (injected into modal) */
    .modal-order-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1.2rem; gap: 1rem; flex-wrap: wrap; }
    .modal-order-id { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.05rem; margin-bottom: 3px; }
    .modal-order-info { font-size: 0.76rem; color: var(--muted); margin-top: 2px; }

    .detail-table { width: 100%; border-collapse: collapse; }
    .detail-table thead th { font-size: 0.66rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; padding: 0.55rem 0.7rem; border-bottom: 1px solid var(--border); text-align: left; background: var(--input-bg); }
    .detail-table tbody td { padding: 0.7rem 0.7rem; border-bottom: 1px solid #1c1b19; font-size: 0.855rem; vertical-align: middle; }
    .detail-table tbody tr:last-child td { border-bottom: none; }
    .detail-table tfoot .total-row td { border-top: 1px solid var(--border); background: var(--input-bg); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.88rem; padding: 0.7rem; border-bottom: none; }
    .detail-table tfoot .grand-total { color: var(--accent); font-size: 1rem; }
    .item-name-cell { display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .mini-thumb { width: 32px; height: 32px; border-radius: 7px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
    .mini-thumb-placeholder { width: 32px; height: 32px; border-radius: 7px; background: var(--input-bg); border: 1px solid var(--border); display: grid; place-items: center; font-size: 0.9rem; flex-shrink: 0; }
    .cat-pill { background: rgba(245,166,35,0.08); color: var(--accent); border: 1px solid rgba(245,166,35,0.15); border-radius: 20px; font-size: 0.66rem; font-weight: 600; padding: 2px 8px; white-space: nowrap; }
    .muted-cell { color: var(--muted); font-size: 0.82rem; }
    .qty-cell { font-family: 'Syne', sans-serif; font-weight: 700; }
    .subtotal-cell { font-family: 'Syne', sans-serif; font-weight: 700; color: var(--accent); }

    .mobile-toggle { display: none; background: transparent; border: none; color: var(--text); font-size: 1.3rem; cursor: pointer; }
    @media (max-width: 768px) { .sidebar { position: fixed; left: -100%; top:0; bottom:0; z-index:100; transition: left 0.3s; } .sidebar.open { left:0; } .mobile-toggle { display: block; } .toolbar { flex-direction: column; align-items: stretch; } .search-wrap { min-width: unset; } }
  </style>
</head>
<body>
<div class="layout">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon">üçΩ</div>
      <div class="brand-text">Campus<span>Eats</span></div>
    </div>
    <div class="admin-pill">
      <div class="admin-avatar">{{ request.session.user_name|first|upper }}</div>
      <div>
        <div class="admin-name">{{ request.session.user_name }}</div>
        <div class="admin-role">{{ request.session.role }}</div>
      </div>
    </div>
    <nav>
      <div class="nav-section">
        <div class="nav-label">Overview</div>
        <a href="{% url 'admin_dashboard' %}" class="nav-item"><span class="nav-icon">‚äû</span> Dashboard</a>
      </div>
      <div class="nav-section">
        <div class="nav-label">User Management</div>
        <a href="{% url 'manage_staff' %}"    class="nav-item "><span class="nav-icon">üë§</span> Staff</a>
        <a href="{% url 'manage_students' %}" class="nav-item"><span class="nav-icon">üéì</span> Students</a>
      </div>
      <div class="nav-section">
        <div class="nav-label">Menu Management</div>
        <a href="{% url 'manage_category' %}" class="nav-item"><span class="nav-icon">‚óà</span> Categories</a>
        <a href="{% url 'manage_items' %}"    class="nav-item"><span class="nav-icon">‚ñ§</span> Items</a>
        <a href="{% url 'prepare_menu' %}"    class="nav-item"><span class="nav-icon">‚ú¶</span> Prepare Menu</a>
      </div>
      <div class="nav-section">
        <div class="nav-label">Wallet & Finance</div>
        <a href="{% url 'recharge_wallet' %}"     class="nav-item"><span class="nav-icon">‚óé</span> Recharge Wallet</a>
        <a href="{% url 'transaction_history' %}" class="nav-item"><span class="nav-icon">‚Üï</span> Transaction History</a>
        <a href="{% url 'revenue' %}"             class="nav-item"><span class="nav-icon">‚óâ</span> Revenue</a>
      </div>
      <div class="nav-section">
        <div class="nav-label">Orders</div>
        <a href="{% url 'order_history' %}" class="nav-item active"><span class="nav-icon">‚â°</span> Order History</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="{% url 'logout' %}" class="logout-btn"><span>‚á§</span> Logout</a>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
  <div class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:0.8rem;">
        <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
        <div>
          <div class="topbar-title">Order History</div>
          <div class="topbar-breadcrumb">Admin &rsaquo; Orders &rsaquo; History</div>
        </div>
      </div>
      <span class="topbar-badge">{{ request.session.role }}</span>
    </div>

    <div class="content">
      <div class="section-title">Order <span>History</span></div>

      <!-- ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ -->
      <form method="GET" action="{% url 'order_history' %}">
        <div class="toolbar">

          <!-- Search -->
          <div class="search-wrap">
            <input type="text" name="q" value="{{ search }}" placeholder="Search by Order ID or Admission No‚Ä¶"/>
          </div>
          <button type="submit" class="btn-search">Search</button>

          <div class="toolbar-divider"></div>

          <!-- Quick filters -->
          <div class="filter-pills">
            <a href="{% url 'order_history' %}"             class="fpill {% if filter_type == 'all'   %}active{% endif %}">All</a>
            <a href="?filter=today{% if search %}&q={{ search }}{% endif %}"  class="fpill {% if filter_type == 'today'  %}active{% endif %}">Today</a>
            <a href="?filter=week{% if search %}&q={{ search }}{% endif %}"   class="fpill {% if filter_type == 'week'   %}active{% endif %}">This Week</a>
            <a href="?filter=month{% if search %}&q={{ search }}{% endif %}"  class="fpill {% if filter_type == 'month'  %}active{% endif %}">This Month</a>
          </div>

          <div class="toolbar-divider"></div>

          <!-- Custom date range -->
          <input type="hidden" name="filter" value="custom"/>
          <div class="custom-range">
            <input type="date" name="date_from" class="date-input"
                   value="{% if filter_type == 'custom' %}{{ date_from }}{% endif %}"/>
            <span class="date-sep">‚Üí</span>
            <input type="date" name="date_to" class="date-input"
                   value="{% if filter_type == 'custom' %}{{ date_to }}{% endif %}"/>
            <button type="submit" class="btn-apply">Apply</button>
          </div>

        </div>
      </form>

      <!-- Results meta -->
      <div class="results-meta">
        <strong>{{ orders|length }}</strong> order{{ orders|length|pluralize }} found
        {% if search %} for <strong>"{{ search }}"</strong>{% endif %}
        {% if filter_type != 'all' %} ¬∑ filtered by <strong>{{ filter_type }}</strong>{% endif %}
      </div>

      <!-- ‚îÄ‚îÄ Orders table ‚îÄ‚îÄ -->
      <div class="table-card">
        {% if orders %}
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Student</th>
                  <th>Date &amp; Time</th>
                  <th>Status</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for order in orders %}
                  <tr>
                    <td class="order-id-cell">#{{ order.id }}</td>
                    <td class="student-cell">
                      <div class="s-name">{{ order.user.name }}</div>
                      <div class="s-adm">{{ order.user.admission_number }}</div>
                    </td>
                    <td class="date-cell">{{ order.ordered_at|date:"d M Y" }}<br/><span style="font-size:0.7rem;">{{ order.ordered_at|time:"h:i A" }}</span></td>
                    <td><span class="status-pill {{ order.status }}">{{ order.get_status_display }}</span></td>
                    <td class="amount-cell">‚Çπ{{ order.total_amount|floatformat:2 }}</td>
                    <td>
                      <button class="btn-detail"
                        onclick="showOrderDetail({{ order.id }})">
                        ‚â° Full Order
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-icon">‚â°</div>
            No orders found.
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Order Detail Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="orderModal">
  <div class="modal">
    <div class="modal-topbar">
      <div class="modal-heading" id="modalHeading">Order Details</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody">
      <div class="modal-loading">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<script>
  function showOrderDetail(orderId) {
    document.getElementById('modalHeading').textContent = 'Order #' + orderId;
    document.getElementById('modalBody').innerHTML = '<div class="modal-loading">Loading‚Ä¶</div>';
    document.getElementById('orderModal').classList.add('show');

    const url = `{% url 'order_detail' 0 %}`.replace('/0/', '/' + orderId + '/');
    fetch(url)
      .then(r => r.text())
      .then(html => {
        document.getElementById('modalBody').innerHTML = html;
      })
      .catch(() => {
        document.getElementById('modalBody').innerHTML = '<div class="modal-loading">Failed to load order details.</div>';
      });
  }

  function closeModal() {
    document.getElementById('orderModal').classList.remove('show');
  }

  document.getElementById('orderModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });
</script>
</body>
</html>